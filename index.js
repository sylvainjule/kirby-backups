(function(){"use strict";function n(t,e,a,s,$,w,x,D){var i=typeof t=="function"?t.options:t;return e&&(i.render=e,i.staticRenderFns=a,i._compiled=!0),{exports:t,options:i}}const o={data(){return{backup:null}},computed:{filename(){return this.backup?this.backup.filename:""}},methods:{open(t){this.backup=t,this.$refs.dialog.open()},resetBackup(){this.backup=null},deleteBackup(){this.$api.post("backups/delete-backup",{filename:this.backup.filename}).then(t=>{t.deleted&&this.$emit("deleted",this.backup.filename),this.$refs.dialog.close()})}}};var l=function(){var e=this,a=e._self._c;return a("k-dialog",{ref:"dialog",attrs:{size:"medium",theme:"negative",icon:"trash",button:e.$t("backups.delete.button")},on:{close:e.resetBackup,cancel:e.resetBackup,submit:e.deleteBackup}},[a("k-text",[e._v(" "+e._s(e.$t("backups.delete.prefix"))+" "),a("strong",[e._v(e._s(e.filename))])])],1)},r=[],c=n(o,l,r);const u=c.exports,p={data(){return{status:"closed",warning:"",toDelete:0,value:{period:null},fields:{period:{label:this.$t("backups.delete.multiple.question"),type:"select",placeholder:this.$t("backups.delete.multiple.placeholder"),options:[{value:"week",text:this.$t("backups.delete.multiple.week")},{value:"month",text:this.$t("backups.delete.multiple.month")},{value:"half",text:this.$t("backups.delete.multiple.half")},{value:"year",text:this.$t("backups.delete.multiple.year")}]}}}},props:{backups:Object},computed:{hasWarning(){return this.status=="warning"&&this.warning.length},loadingSimulation(){return this.status=="warning"&&!this.hasWarning},canDelete(){return this.hasWarning&&this.toDelete>0}},methods:{open(){this.resetValue(),this.status="open",this.$refs.dialog.open()},onPeriodChange(){this.value.period&&this.value.period.length?this.simulate():this.status="open"},simulate(){this.status="warning",this.warning="",this.$api.get("backups/simulate-deletion",{period:this.value.period}).then(t=>{this.warning=t.toDelete.text,this.toDelete=t.toDelete.count})},deleteBackups(){this.$api.post("backups/delete-backups",{period:this.value.period}).then(t=>{this.$emit("deleted",t.deleted),this.$refs.dialog.close()})},resetValue(){this.value={period:null},this.warning=""}}};var d=function(){var e=this,a=e._self._c;return a("k-dialog",{ref:"dialog",class:["backups-delete-dialog",{"can-delete":e.canDelete}],attrs:{button:e.$t("backups.delete.multiple.button"),theme:"negative",icon:"trash",size:"medium"},on:{submit:e.deleteBackups}},[a("k-form",{ref:"form",staticClass:"backups-delete-form",attrs:{fields:e.fields},on:{input:e.onPeriodChange},model:{value:e.value,callback:function(s){e.value=s},expression:"value"}}),e.hasWarning?a("k-box",{attrs:{theme:"info"}},[a("k-text",{domProps:{innerHTML:e._s(e.warning)}})],1):e.loadingSimulation?a("div",{staticClass:"warning-loading"},[a("k-icon",{attrs:{type:"backupsLoader"}})],1):e._e()],1)},h=[],k=n(p,d,h);const b=k.exports,m={components:{"backup-delete-dialog":u,"backups-delete-dialog":b},props:{backups:Array,title:String,limit:Number},data(){return{downloading:!1,creationStatus:"default",page:1}},computed:{columns(){return{filename:{label:this.$t("backups.filename"),type:"text"},size:{label:this.$t("backups.size"),type:"text"},date:{label:this.$t("backups.created"),type:"text"}}},options(){return[{text:"Download",icon:"download",click:"download"},"-",{text:"Delete",icon:"trash",click:"delete"}]},pagination(){let t=0;return this.limit&&(t=(this.page-1)*this.limit),{page:this.page,offset:t,limit:this.limit,total:this.backups.length,align:"center",details:!0}},index(){return(this.pagination.page-1)*this.pagination.limit+1},paginatedBackups(){return this.backups.slice(this.index-1,this.pagination.limit*this.pagination.page)}},mounted(){window.beforeunload=this.deletePublicBackups()},destroyed(){this.deletePublicBackups()},methods:{async createBackup(){this.creationStatus="progress";try{const t=await this.$api.get("backups/create-backup");await this.$reload(),this.setCreationStatus(t.status,!0)}catch{this.setCreationStatus("error",!0)}},setCreationStatus(t,e=!0){this.creationStatus=t==200?"success":"error",e&&setTimeout(()=>{this.creationStatus="default"},2e3)},onOption(t,e,a){t=="download"?this.copyAndDownload(e.filename):t=="delete"&&this.openBackupDeleteDialog(e)},async copyAndDownload(t){this.downloading=t,t=t=="latest"?this.backups[0].filename:t;const e=await this.$api.get("backups/copy-to-assets",{filename:t});e.url&&(window.location=e.url),this.downloading=!1},openBackupDeleteDialog(t){this.$refs["backup-delete"].open(t)},openBackupsDeleteDialog(){this.$refs["backups-delete"].open()},deletePublicBackups(){this.$api.post("backups/delete-public-backups")}}};var f=function(){var e=this,a=e._self._c;return a("k-panel-inside",[a("k-view",{staticClass:"k-backups-view"},[a("k-header",{staticClass:"k-backups-view-header"},[e._v(" "+e._s(e.title)+" "),e.backups.length?a("k-button-group",{attrs:{slot:"buttons"},slot:"buttons"},[e.creationStatus=="default"?a("k-button",{attrs:{icon:"add",variant:"filled",text:e.$t("backups.create"),size:"sm"},on:{click:e.createBackup}}):e.creationStatus=="progress"?a("k-button",{attrs:{icon:"loader",disabled:!0,variant:"filled",text:e.$t("backups.create.process"),size:"sm"}}):e.creationStatus=="success"?a("k-button",{attrs:{icon:"check",disabled:!0,theme:"positive",variant:"filled",text:e.$t("backups.create.success"),size:"sm"}}):e.creationStatus=="error"?a("k-button",{attrs:{icon:"alert",disabled:!0,theme:"negative",variant:"filled",text:e.$t("backups.create.error"),size:"sm"}}):e._e(),e.downloading!=="latest"?a("k-button",{attrs:{icon:"download",variant:"filled",text:e.$t("backups.download.latest"),size:"sm"},on:{click:function(s){return e.copyAndDownload("latest")}}}):a("k-button",{attrs:{icon:"loader",disabled:!0,variant:"filled",text:e.$t("backups.downloading"),size:"sm"}}),a("k-button",{attrs:{icon:"trash",variant:"filled",text:e.$t("backups.delete.some"),size:"sm"},on:{click:e.openBackupsDeleteDialog}})],1):e._e()],1),a("k-table",{attrs:{columns:e.columns,options:e.options,empty:e.$t("backups.placeholder"),pagination:e.pagination,index:e.index,sortable:!1,rows:e.paginatedBackups},on:{paginate:function(s){e.page=s.page},option:e.onOption}}),a("backup-delete-dialog",{ref:"backup-delete",on:{deleted:e.$reload}}),a("backups-delete-dialog",{ref:"backups-delete",attrs:{backups:e.backups},on:{deleted:e.$reload}})],1)],1)},g=[],v=n(m,f,g);const _=v.exports;panel.plugin("sylvainjule/backups",{components:{"k-backups-view":_},icons:{backup:'<path d="M7.12,11.86a.56.56,0,0,1-.4-.16l-2-2a.56.56,0,0,1,.79-.79L7.12,10.5l3.56-3.56a.56.56,0,0,1,.79.79l-4,4A.56.56,0,0,1,7.12,11.86Z"/><path d="M14,15.45H2.17A2.17,2.17,0,0,1,0,13.28V1.41A.69.69,0,0,1,.69.72H6.13a.69.69,0,0,1,.59.33L8,3.19h7.52a.69.69,0,0,1,.69.69v9.4A2.17,2.17,0,0,1,14,15.45ZM1.38,2.1V13.28a.8.8,0,0,0,.79.79H14a.8.8,0,0,0,.8-.79V4.57H7.61A.69.69,0,0,1,7,4.23L5.74,2.1Z"/>',backupsLoader:'<g fill="none" fill-rule="evenodd"><g transform="translate(1 1)" stroke-width="1.75"><circle cx="7" cy="7" r="7.2" stroke="#000" stroke-opacity=".2"/><path d="M14.2,7c0-4-3.2-7.2-7.2-7.2" stroke="#000"><animateTransform attributeName="transform" type="rotate" from="0 7 7" to="360 7 7" dur="1s" repeatCount="indefinite"/></path></g></g>'}})})();
